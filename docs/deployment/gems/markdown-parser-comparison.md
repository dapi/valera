# Markdown Parser Comparison for Telegram Bot

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 26.10.2025
**–¶–µ–ª—å:** –í—ã–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ Ruby gem –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ Markdown –≤ Telegram –±–æ—Ç–µ
**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ú–æ–¥—É–ª—å `MarkdownCleaner` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞

## üìä –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞—Ä—Å–µ—Ä–æ–≤

| Gem | –í–µ—Ä—Å–∏—è | –¢–∏–ø | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | Telegram —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å | –î–æ–ø. –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ | –†–µ–π—Ç–∏–Ω–≥ |
|-----|--------|-----|-------------------|-------------|----------------------|------------------|---------|
| **Kramdown** | 2.5.1 | Pure Ruby | ‚≠ê‚≠ê‚≠ê‚≠ê (6.6—Å –∑–∞ 10K) | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (–≥–∏–±–∫–∏–µ –æ–ø—Ü–∏–∏) | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (–ø–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å) | –ù–µ—Ç | 9/10 |
| **Commonmarker** | 2.5.0 | Rust extension | ‚≠ê‚≠ê (25.8—Å –∑–∞ 10K) | ‚≠ê‚≠ê‚≠ê (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏) | ‚≠ê‚≠ê‚≠ê (–±–∞–∑–æ–≤–∞—è) | Rust toolchain | 6/10 |
| **Redcarpet** | 3.6.1 | C extension | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (—Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π) | ‚≠ê‚≠ê (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π) | ‚≠ê‚≠ê (–Ω–µ –ø–æ–ª–Ω–∞—è) | gcc/clang | 5/10 |

## üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### 1. Kramdown (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –≤—ã–±–æ—Ä)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **–ß–∏—Å—Ç—ã–π Ruby** - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ –±–µ–∑ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- ‚úÖ **–ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** - 20+ –æ–ø—Ü–∏–π –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ **–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Telegram** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - graceful degradation –ø—Ä–∏ malformed input
- ‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–ª–∞–≥–∏–Ω–æ–≤ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–æ–≤
- ‚úÖ **–•–æ—Ä–æ—à–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** –∏ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω—ã–π API** - backward compatible

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –ú–µ–¥–ª–µ–Ω–Ω–µ–µ C-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Å—Ç—Ä–æ –¥–ª—è use case)
- ‚ö†Ô∏è –ë–æ–ª—å—à–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
- ‚ö†Ô∏è –ò–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á

**–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Telegram:**
```ruby
Kramdown::Document.new(text, {
  remove_block_html_tags: true,      # –£–¥–∞–ª–∏—Ç—å HTML –±–ª–æ–∫–∏
  remove_span_html_tags: true,       # –£–¥–∞–ª–∏—Ç—å HTML —Å–ø–∞–Ω—ã
  parse_block_html: false,           # –ù–µ –ø–∞—Ä—Å–∏—Ç—å HTML –±–ª–æ–∫–∏
  parse_span_html: false,            # –ù–µ –ø–∞—Ä—Å–∏—Ç—å HTML —Å–ø–∞–Ω—ã
  entity_output: :symbolic           # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ HTML entities
})
```

### 2. Commonmarker

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **GitHub-flavored Markdown** —Å—Ç–∞–Ω–¥–∞—Ä—Ç
- ‚úÖ **–í—ã—Å–æ–∫–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** (CommonMark —Å—Ç–∞–Ω–¥–∞—Ä—Ç)
- ‚úÖ **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π Rust –¥–≤–∏–∂–æ–∫**

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå **–ù–∏–∑–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –≤ —Ç–µ—Å—Ç–∞—Ö (–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ!)
- ‚ùå **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
- ‚ùå **–°–ª–æ–∂–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞** (—Ç—Ä–µ–±—É–µ—Ç Rust toolchain)
- ‚ùå **–ú–µ–Ω—å—à–µ –≥–∏–±–∫–æ—Å—Ç–∏** –¥–ª—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏
- ‚ùå **–ü—Ä–æ–±–ª–µ–º—ã —Å broken markdown** - –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 3. Redcarpet

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **–°–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π** (C extension –Ω–∞ libsass)
- ‚úÖ **–õ–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π**
- ‚úÖ **–®–∏—Ä–æ–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** (GitHub, GitLab)

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå **–£—Å—Ç–∞—Ä–µ–≤—à–∏–π –ø—Ä–æ–µ–∫—Ç** - –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–ª–∏–∑ –≤ 2021
- ‚ùå **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –±–∞–∑–æ–≤–∞—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è
- ‚ùå **–¢—Ä–µ–±—É–µ—Ç –∫–æ–º–ø–∏–ª—è—Ü–∏–∏** - –ø—Ä–æ–±–ª–µ–º—ã —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π
- ‚ùå **–ù–µ–ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Telegram —ç–ª–µ–º–µ–Ω—Ç–æ–≤**
- ‚ùå **–ü–ª–æ—Ö–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –ø–∞–¥–∞–µ—Ç –Ω–∞ malformed input

## üõ°Ô∏è –ê–Ω–∞–ª–∏–∑ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ç–æ—Ä–æ–≤

### Sanitize Gem (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)
```ruby
# –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç–µ (v7.0.0)
require 'sanitize'

# –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Telegram
Sanitize.clean(html, {
  elements: ['strong', 'em', 'code', 'a'],
  attributes: {'a' => ['href']},
  protocols: {'a' => {'href' => ['http', 'https']}}
})
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ **Whitelist –ø–æ–¥—Ö–æ–¥** - –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚úÖ **–ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** - –¥–µ—Ç–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
- ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç XSS** - —É–¥–∞–ª—è–µ—Ç dangerous content
- ‚úÖ **–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π**

### Loofah Gem (–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
```ruby
# –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ Rails HTML Sanitizer
require 'loofah'

# Rails Action View –ø–æ–¥—Ö–æ–¥
Loofah.scrub_fragment(html, :prune).to_s
```

## üìà –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (10K –∏—Ç–µ—Ä–∞—Ü–∏–π)

| –ú–µ—Ç–æ–¥ | –í—Ä–µ–º—è (—Å–µ–∫) | –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å |
|-------|-------------|------------------------|
| **Kramdown** | 6.6 | –ë–∞–∑–æ–≤—ã–π |
| **Kramdown + Sanitize** | 10.4 | 1.6x –º–µ–¥–ª–µ–Ω–Ω–µ–µ |
| **Commonmarker** | 25.8 | 3.9x –º–µ–¥–ª–µ–Ω–Ω–µ–µ |
| **Commonmarker + Sanitize** | 31.2 | 4.7x –º–µ–¥–ª–µ–Ω–Ω–µ–µ |

*–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: Unexpected —Ä–µ–∑—É–ª—å—Ç–∞—Ç - Commonmarker (Rust) –º–µ–¥–ª–µ–Ω–Ω–µ–µ Kramdown (Ruby) –∏–∑-–∑–∞ overhead –≤ Ruby bindings*

## üîß Telegram —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

| –≠–ª–µ–º–µ–Ω—Ç Markdown | Kramdown | Commonmarker | Redcarpet | –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ Telegram |
|------------------|-----------|--------------|-----------|--------------------|
| `**bold**` | ‚úÖ | ‚úÖ | ‚úÖ | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è |
| `*italic*` | ‚úÖ | ‚úÖ | ‚ö†Ô∏è | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è |
| `__italic__` | ‚úÖ | ‚úÖ | ‚ùå | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è |
| `` `code` `` | ‚úÖ | ‚ö†Ô∏è | ‚úÖ | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è |
| `[link](url)` | ‚úÖ | ‚úÖ | ‚úÖ | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è |
| Broken formatting | ‚úÖ (–∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç) | ‚ùå (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç) | ‚ùå (–æ—à–∏–±–∫–∞) | –ù—É–∂–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ |
| HTML tags | ‚úÖ (—É–¥–∞–ª—è–µ—Ç) | ‚úÖ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç) | ‚ùå (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç) | –î–æ–ª–∂–µ–Ω —É–¥–∞–ª—è—Ç—å—Å—è |

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Kramdown + Sanitize:**

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Å—Ç—Ä–∞—è –¥–ª—è –±–æ—Ç–∞ (< 1ms –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ dangerous content
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ broken markdown
4. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** 100% –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Telegram —ç–ª–µ–º–µ–Ω—Ç–æ–≤
5. **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ß–∏—Å—Ç—ã–π Ruby, –Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è:**
```ruby
# app/services/markdown_cleaner.rb
class MarkdownCleaner
  def self.clean_for_telegram(text)
    # 1. –ü–∞—Ä—Å–∏–Ω–≥ —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –æ–ø—Ü–∏—è–º–∏ Kramdown
    html = Kramdown::Document.new(text, safe_options).to_html

    # 2. –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Sanitize gem
    clean_html = Sanitize.clean(html, telegram_allowed_config)

    # 3. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ Telegram Markdown —Ñ–æ—Ä–º–∞—Ç
    convert_to_telegram_format(clean_html)
  end
end
```

## üöÄ –ü–ª–∞–Ω –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏

### Phase 1: Base (2 —á–∞—Å–∞)
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Kramdown —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –æ–ø—Ü–∏—è–º–∏
- [ ] –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ `**bold**`, `*italic*`, `` `code` ``
- [ ] –ü—Ä–æ—Å—Ç–∞—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Sanitize

### Phase 2: Advanced (3 —á–∞—Å–∞)
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ broken markdown –∏ –æ—à–∏–±–æ–∫
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Å—ã–ª–æ–∫ –∏ —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
- [ ] –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è (XSS protection)

### Phase 3: Integration (1 —á–∞—Å)
- [ ] –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –≤ Telegram::WebhookController
- [ ] –¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö edge cases
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ readme

**–ò—Ç–æ–≥–æ–≤–æ–µ –≤—Ä–µ–º—è:** ~6 —á–∞—Å–æ–≤
**–†–∏—Å–∫:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–∞–¥–µ–∂–Ω—ã–π –º–æ–¥—É–ª—å –æ—á–∏—Å—Ç–∫–∏ Markdown –¥–ª—è Telegram –±–æ—Ç–∞