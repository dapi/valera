h1.text-2xl.font-bold.text-gray-800.mb-6 –û–±–∑–æ—Ä

= turbo_frame_tag "dashboard_stats" do
  / KPI –ö–∞—Ä—Ç–æ—á–∫–∏
  .grid.grid-cols-1.md:grid-cols-2.lg:grid-cols-5.gap-6
    / Clients card ‚Äî –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è
    = link_to tenant_clients_path, class: "bg-white rounded-lg shadow p-6 hover:shadow-lg transition-shadow block"
      .flex.items-center.justify-between
        .text-sm.font-medium.text-gray-500 –ö–ª–∏–µ–Ω—Ç—ã
        span.text-2xl üë•
      .text-3xl.font-bold.text-gray-800.mt-2 = @stats.clients_total
      .text-sm.mt-1
        span.text-green-600 +#{@stats.clients_today} —Å–µ–≥–æ–¥–Ω—è
        span.text-gray-400.mx-1 ‚Ä¢
        span.text-green-600 +#{@stats.clients_week} –∑–∞ –Ω–µ–¥–µ–ª—é

    / Bookings card ‚Äî –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è
    = link_to tenant_bookings_path, class: "bg-white rounded-lg shadow p-6 hover:shadow-lg transition-shadow block"
      .flex.items-center.justify-between
        .text-sm.font-medium.text-gray-500 –ó–∞—è–≤–∫–∏
        span.text-2xl üìù
      .text-3xl.font-bold.text-gray-800.mt-2 = @stats.bookings_total
      .text-sm.text-green-600.mt-1 +#{@stats.bookings_today} —Å–µ–≥–æ–¥–Ω—è

    / Active chats card
    .bg-white.rounded-lg.shadow.p-6
      .flex.items-center.justify-between
        .text-sm.font-medium.text-gray-500 –ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã
        span.text-2xl üí¨
      .text-3xl.font-bold.text-gray-800.mt-2 = @stats.active_chats
      .text-sm.text-gray-500.mt-1 –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24—á

    / Messages today card
    .bg-white.rounded-lg.shadow.p-6
      .flex.items-center.justify-between
        .text-sm.font-medium.text-gray-500 –°–æ–æ–±—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è
        span.text-2xl üì®
      .text-3xl.font-bold.text-gray-800.mt-2 = @stats.messages_today

    / Average messages per dialog card
    .bg-white.rounded-lg.shadow.p-6
      .flex.items-center.justify-between
        .text-sm.font-medium.text-gray-500 –°–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–∏–∞–ª–æ–≥–µ
        span.text-2xl üìä
      .text-3xl.font-bold.text-gray-800.mt-2 = @stats.avg_messages_per_dialog
      .text-sm.text-gray-500.mt-1 –≤ —Å—Ä–µ–¥–Ω–µ–º

  / –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
  .grid.grid-cols-1.lg:grid-cols-3.gap-6.mt-8
    / –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–∑–∞–Ω–∏–º–∞–µ—Ç 2 –∫–æ–ª–æ–Ω–∫–∏)
    .lg:col-span-2.bg-white.rounded-lg.shadow.p-6 data-controller="chart"
      .flex.items-center.justify-between.mb-4
        h2.text-lg.font-semibold.text-gray-800 üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        .flex.gap-2
          = link_to "7 –¥–Ω–µ–π", tenant_root_path(period: 7), data: { turbo_frame: "dashboard_stats" }, class: "px-3 py-1 text-sm rounded transition-colors #{@period == 7 ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
          = link_to "30 –¥–Ω–µ–π", tenant_root_path(period: 30), data: { turbo_frame: "dashboard_stats" }, class: "px-3 py-1 text-sm rounded transition-colors #{@period == 30 ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
          = link_to "90 –¥–Ω–µ–π", tenant_root_path(period: 90), data: { turbo_frame: "dashboard_stats" }, class: "px-3 py-1 text-sm rounded transition-colors #{@period == 90 ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
          = link_to "–í—Å—ë –≤—Ä–µ–º—è", tenant_root_path(period: "all"), data: { turbo_frame: "dashboard_stats" }, class: "px-3 py-1 text-sm rounded transition-colors #{@period.nil? ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"

      .h-64
        canvas data-chart-target="canvas" data-chart-labels=@stats.chart_data[:labels].to_json data-chart-values=@stats.chart_data[:values].to_json

    / –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
    .bg-white.rounded-lg.shadow.p-6
      h2.text-lg.font-semibold.text-gray-800.mb-4 üìä –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

      .space-y-4
        / –î–∏–∞–ª–æ–≥–∏
        div
          .flex.items-center.justify-between.mb-1
            span.text-sm.font-medium.text-gray-600 –î–∏–∞–ª–æ–≥–∏
            span.text-lg.font-bold.text-gray-800 = @stats.funnel_data[:chats_count]
          .w-full.bg-gray-200.rounded-full.h-3
            .bg-blue-500.h-3.rounded-full style="width: 100%"

        / –ó–∞—è–≤–∫–∏
        div
          .flex.items-center.justify-between.mb-1
            span.text-sm.font-medium.text-gray-600 –ó–∞—è–≤–∫–∏
            span.text-lg.font-bold.text-gray-800 = @stats.funnel_data[:bookings_count]
          - bar_width = [@stats.funnel_data[:conversion_rate].round, 100].min
          .w-full.bg-gray-200.rounded-full.h-3
            .bg-green-500.h-3.rounded-full style="width: #{bar_width}%"

        / –ö–æ–Ω–≤–µ—Ä—Å–∏—è
        .pt-4.border-t.border-gray-200
          .flex.items-center.justify-between
            span.text-sm.font-medium.text-gray-600 –ö–æ–Ω–≤–µ—Ä—Å–∏—è
            span.text-2xl.font-bold.text-green-600 #{@stats.funnel_data[:conversion_rate]}%

  / –¢—Ä–µ–Ω–¥ –≤–æ—Ä–æ–Ω–∫–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º
  - if @stats.funnel_trend.any?
    .mt-8.bg-white.rounded-lg.shadow.p-6
      h2.text-lg.font-semibold.text-gray-800.mb-4 üìà –¢—Ä–µ–Ω–¥ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º

      .overflow-x-auto
        table.min-w-full.divide-y.divide-gray-200
          thead.bg-gray-50
            tr
              th.px-4.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider –ù–µ–¥–µ–ª—è
              th.px-4.py-3.text-right.text-xs.font-medium.text-gray-500.uppercase.tracking-wider –î–∏–∞–ª–æ–≥–∏
              th.px-4.py-3.text-right.text-xs.font-medium.text-gray-500.uppercase.tracking-wider –ó–∞—è–≤–∫–∏
              th.px-4.py-3.text-right.text-xs.font-medium.text-gray-500.uppercase.tracking-wider –ö–æ–Ω–≤–µ—Ä—Å–∏—è
              th.px-4.py-3.text-center.text-xs.font-medium.text-gray-500.uppercase.tracking-wider –¢—Ä–µ–Ω–¥
          tbody.bg-white.divide-y.divide-gray-200
            - @stats.funnel_trend.each_with_index do |week, index|
              - prev_week = index > 0 ? @stats.funnel_trend[index - 1] : nil
              - trend_diff = prev_week ? (week.conversion_rate - prev_week.conversion_rate).round(1) : nil
              tr
                td.px-4.py-3.whitespace-nowrap.text-sm.text-gray-900
                  = "#{week.week_start.strftime('%d.%m')} - #{week.week_end.strftime('%d.%m')}"
                td.px-4.py-3.whitespace-nowrap.text-sm.text-gray-900.text-right
                  = week.chats_count
                td.px-4.py-3.whitespace-nowrap.text-sm.text-gray-900.text-right
                  = week.bookings_count
                td.px-4.py-3.whitespace-nowrap.text-sm.font-medium.text-right
                  span class=(week.conversion_rate >= 10 ? 'text-green-600' : week.conversion_rate >= 5 ? 'text-yellow-600' : 'text-gray-600')
                    = "#{week.conversion_rate}%"
                td.px-4.py-3.whitespace-nowrap.text-sm.text-center
                  - if trend_diff
                    - if trend_diff > 0
                      span.text-green-600 ‚Üë +#{trend_diff}%
                    - elsif trend_diff < 0
                      span.text-red-600 ‚Üì #{trend_diff}%
                    - else
                      span.text-gray-400 ‚Äî
                  - else
                    span.text-gray-400 ‚Äî

  / –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã –æ–±—Ä–∞—â–µ–Ω–∏–π
  - if @stats.popular_topics.any?
    .mt-8.bg-white.rounded-lg.shadow.p-6
      h2.text-lg.font-semibold.text-gray-800.mb-4 üè∑Ô∏è –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã –æ–±—Ä–∞—â–µ–Ω–∏–π

      .grid.grid-cols-1.md:grid-cols-2.gap-4
        - @stats.popular_topics.each_with_index do |topic_data, index|
          .flex.items-center.gap-3.p-3.rounded-lg class=(index < 3 ? 'bg-blue-50' : 'bg-gray-50')
            / –ü–æ–∑–∏—Ü–∏—è
            .flex-shrink-0.w-8.h-8.rounded-full.flex.items-center.justify-center.text-sm.font-bold class=(index < 3 ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-700')
              = index + 1

            / –ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            .flex-1.min-w-0
              .font-medium.text-gray-800.truncate = topic_data.topic.label
              .text-sm.text-gray-500
                = "#{topic_data.count} "
                = topic_data.count == 1 ? '—á–∞—Ç' : topic_data.count < 5 ? '—á–∞—Ç–∞' : '—á–∞—Ç–æ–≤'

            / –ü—Ä–æ—Ü–µ–Ω—Ç
            .flex-shrink-0.text-right
              .text-lg.font-bold class=(index < 3 ? 'text-blue-600' : 'text-gray-600')
                = "#{topic_data.percentage}%"

      / –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –æ –Ω–µ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∞—Ç–∞—Ö
      - total_chats = @stats.funnel_data[:chats_count]
      - classified_chats = @stats.popular_topics.sum(&:count)
      - unclassified = total_chats - classified_chats
      - if unclassified > 0
        .mt-4.pt-4.border-t.border-gray-200.text-sm.text-gray-500
          = "–ï—â—ë #{unclassified} "
          = unclassified == 1 ? '—á–∞—Ç' : unclassified < 5 ? '—á–∞—Ç–∞' : '—á–∞—Ç–æ–≤'
          |  –±–µ–∑ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏

  / –†–∞—Å—Ö–æ–¥—ã –Ω–∞ AI
  .mt-8.bg-white.rounded-lg.shadow.p-6
    h2.text-lg.font-semibold.text-gray-800.mb-4 üí∞ –†–∞—Å—Ö–æ–¥—ã –Ω–∞ AI

    - totals = @stats.llm_costs[:totals]
    - by_model = @stats.llm_costs[:by_model]

    .grid.grid-cols-1.lg:grid-cols-2.gap-6
      / –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
      div
        .space-y-3
          / Input tokens
          .flex.items-center.justify-between.py-2.border-b.border-gray-100
            span.text-sm.text-gray-600 Input tokens
            .text-right
              span.font-medium.text-gray-800 = format_tokens(totals.input_tokens)
              span.text-gray-400.ml-2 = format_cost(totals.input_cost)

          / Output tokens
          .flex.items-center.justify-between.py-2.border-b.border-gray-100
            span.text-sm.text-gray-600 Output tokens
            .text-right
              span.font-medium.text-gray-800 = format_tokens(totals.output_tokens)
              span.text-gray-400.ml-2 = format_cost(totals.output_cost)

          / –ò—Ç–æ–≥–æ
          .flex.items-center.justify-between.py-2.bg-gray-50.rounded-lg.px-3
            span.text-sm.font-medium.text-gray-700 –ò—Ç–æ–≥–æ
            .text-right
              span.font-bold.text-gray-800 = format_tokens(totals.total_tokens)
              span.text-lg.font-bold.text-green-600.ml-2 = format_cost(totals.total_cost)

      / Breakdown –ø–æ –º–æ–¥–µ–ª—è–º
      div
        - if by_model.any?
          h3.text-sm.font-medium.text-gray-500.mb-3 –ü–æ –º–æ–¥–µ–ª—è–º:
          .space-y-2
            - by_model.each do |model_stats|
              - percentage = totals.total_cost.positive? ? (model_stats.total_cost / totals.total_cost * 100).round(1) : 0
              .flex.items-center.justify-between.py-2
                .flex.items-center.gap-2
                  span.text-sm.text-gray-700 = model_stats.model_name || model_stats.model_id
                  span.text-xs.text-gray-400 = model_stats.provider
                .text-right
                  span.font-medium.text-gray-800 = format_cost(model_stats.total_cost)
                  span.text-xs.text-gray-400.ml-1 = "(#{percentage}%)"
        - else
          .text-center.py-4
            p.text-gray-500.text-sm –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö
            p.text-xs.text-gray-400.mt-1 –†–∞—Å—Ö–æ–¥—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞

    / –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –¥–Ω—è–º
    - if @stats.llm_costs[:chart_data][:values].any? { |v| v > 0 }
      .mt-6.pt-6.border-t.border-gray-200 data-controller="cost-chart"
        h3.text-sm.font-medium.text-gray-500.mb-3 –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤
        .h-48
          canvas data-cost-chart-target="canvas" data-cost-chart-labels=@stats.llm_costs[:chart_data][:labels].to_json data-cost-chart-values=@stats.llm_costs[:chart_data][:values].to_json

  / –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∏
  .mt-8.bg-white.rounded-lg.shadow.p-6
    h2.text-lg.font-semibold.text-gray-800.mb-4 üïê –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∏

    - if @stats.recent_chats.any?
      .space-y-4
        - @stats.recent_chats.each do |chat|
          .border.rounded-lg.p-4.hover:bg-gray-50.transition-colors
            / –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
            .flex.items-center.justify-between.mb-3
              .flex.items-center.gap-2
                span.text-sm.font-medium.text-gray-800 = chat.client.display_name
                - if chat.messages.any?
                  span.text-xs.text-gray-400 = time_ago_in_words(chat.messages.last.created_at) + " –Ω–∞–∑–∞–¥"

            / –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
            - if chat.messages.any?
              .space-y-2.pl-2.border-l-2.border-gray-200
                - chat.messages.order(created_at: :desc).limit(4).reverse.each do |msg|
                  .flex.items-start.gap-2
                    span.text-xs.flex-shrink-0 = msg.role == "user" ? "üë§" : "ü§ñ"
                    p.text-sm.text-gray-600.truncate = truncate(msg.content, length: 60)
    - else
      .text-center.py-8
        p.text-gray-500 –î–∏–∞–ª–æ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç
        p.text-sm.text-gray-400.mt-1 –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç—ã –Ω–∞—á–Ω—É—Ç –æ–±—â–∞—Ç—å—Å—è —Å –±–æ—Ç–æ–º, –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –∏—Ö –¥–∏–∞–ª–æ–≥–∏
